<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inferno | Origami Gallery</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Outfit:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --fire: #ff4d00;
            --ember: #ffcc00;
            --bg: #050505;
            --card-bg: #111;
        }

        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Outfit', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        #bgCanvas { position: fixed; top: 0; left: 0; z-index: -1; }

        .timeline-container {
            max-width: 1000px;
            margin: 100px auto;
            position: relative;
            padding: 20px;
        }

        /* Glowing Center Line */
        .timeline-container::before {
            content: ''; position: absolute; left: 50%; transform: translateX(-50%);
            width: 2px; height: 100%; top: 0;
            background: linear-gradient(to bottom, transparent, var(--fire), var(--ember), transparent);
            box-shadow: 0 0 15px var(--fire);
        }

        .node {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 100px; position: relative;
        }
        .node:nth-child(even) { flex-direction: row-reverse; }

        .node-dot {
            position: absolute; left: 50%; transform: translateX(-50%);
            width: 20px; height: 20px; background: var(--ember);
            border-radius: 50%; box-shadow: 0 0 20px var(--fire); z-index: 5;
        }

        /* --- STACKED CARD DESIGN --- */
        .card-wrapper {
            width: 45%;
            position: relative;
            cursor: pointer;
            perspective: 1000px;
        }

        .event-title {
            font-family: 'Cinzel', serif; color: var(--ember);
            font-size: 1.2rem; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }

        /* The Visual "Paper Stack" Effect */
        .photo-stack {
            position: relative;
            width: 100%;
            aspect-ratio: 16/10;
        }

        /* Fake photos behind the main one */
        .photo-stack::before, .photo-stack::after {
            content: ''; position: absolute; inset: 0;
            background: #222; border: 1px solid #444; border-radius: 8px;
            transition: transform 0.4s ease;
            z-index: 0;
        }
        
        .photo-stack::before { transform: rotate(-3deg); }
        .photo-stack::after { transform: rotate(3deg); }

        /* Fan out effect on hover */
        .card-wrapper:hover .photo-stack::before { transform: rotate(-6deg) translateX(-5px); }
        .card-wrapper:hover .photo-stack::after { transform: rotate(6deg) translateX(5px); }

        /* The Main Image Container */
        .current-photo-box {
            position: absolute; inset: 0;
            background: #000;
            border: 1px solid var(--fire);
            border-radius: 8px;
            overflow: hidden;
            z-index: 2;
        }

        .current-photo-box img {
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0; transition: opacity 0.5s;
            position: absolute; top:0; left:0;
        }
        .current-photo-box img.active { opacity: 1; }

        /* Image Counter Badge */
        .stack-badge {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0,0,0,0.8); color: var(--ember);
            padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;
            border: 1px solid var(--fire); z-index: 10;
        }

        /* Progress Bar for Sliding */
        .slide-progress {
            position: absolute; bottom: 0; left: 0; height: 3px;
            background: var(--fire); width: 0%;
            transition: width 0.3s linear;
            z-index: 10;
        }

        /* --- COMPLEX ORIGAMI MODAL --- */
        .modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            display: none; justify-content: center; align-items: center;
            z-index: 9999;
            perspective: 2500px; /* Deep 3D space */
        }

        .origami-stage {
            width: 90%; max-width: 800px;
            height: 60vh; /* Adjust based on image ratio */
            position: relative;
            transform-style: preserve-3d;
        }

        /* The 4 Folding Segments */
        .fold-slice {
            width: 100%; height: 25%; /* 4 slices = 25% each */
            position: absolute; left: 0;
            background-size: 100% 400%; /* Stretch image across slices */
            background-repeat: no-repeat;
            transform-origin: top;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.25, 1, 0.5, 1);
            background-color: #000;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Initial Folded State (Zig-Zag) */
        .modal:not(.open) .fold-slice { opacity: 0; }
        
        .modal.open { display: flex; }

        /* Positioning Logic */
        .s1 { top: 0; background-position: 0% 0%; }
        
        /* Each slice hangs off the previous one in 3D space */
        .s2 { top: 100%; background-position: 0% 33.33%; transform-origin: top; }
        .s3 { top: 100%; background-position: 0% 66.66%; transform-origin: top; }
        .s4 { top: 100%; background-position: 0% 100%; transform-origin: top; }

        /* The Fold Animation Classes */
        /* Closed State */
        .origami-stage.folded .s1 { transform: rotateX(60deg); }
        .origami-stage.folded .s2 { transform: rotateX(-120deg); }
        .origami-stage.folded .s3 { transform: rotateX(120deg); }
        .origami-stage.folded .s4 { transform: rotateX(-120deg); }

        /* Open State (Flat) */
        .origami-stage.unfolded .s1 { transform: rotateX(0deg); }
        .origami-stage.unfolded .s2 { transform: rotateX(0deg); }
        .origami-stage.unfolded .s3 { transform: rotateX(0deg); }
        .origami-stage.unfolded .s4 { transform: rotateX(0deg); }

        @media (max-width: 768px) {
            .node { flex-direction: row !important; justify-content: flex-start; padding-left: 40px; }
            .card-wrapper { width: 90%; }
            .timeline-container::before, .node-dot { left: 20px; }
            .origami-stage { height: 40vh; }
        }
    </style>
</head>
<body>

<canvas id="bgCanvas"></canvas>

<div class="timeline-container" id="gallery"></div>

<!-- Origami Modal Structure -->
<div class="modal" id="modal" onclick="foldAndClose()">
    <div class="origami-stage folded" id="stage">
        <!-- These slices will be painted with the image via JS -->
        <div class="fold-slice s1">
            <div class="fold-slice s2">
                <div class="fold-slice s3">
                    <div class="fold-slice s4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIGURATION --- */
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzuOEfCRHEBMA216pJ3oJYaVED2ohOCxAw_XNCbFlf8CK9r-j3K--BXGxcVDOeQHxKJug/exec'; 

    /* --- 1. FETCH DATA --- */
    async function initGallery() {
        try {
            const res = await fetch(APPS_SCRIPT_URL);
            const data = await res.json();
            renderTimeline(data);
        } catch (e) {
            console.error("Data Load Error:", e);
        }
    }

    function renderTimeline(events) {
        const container = document.getElementById('gallery');
        events.forEach(ev => {
            const count = ev.images.length;
            const card = document.createElement('div');
            card.className = 'node';
            card.innerHTML = `
                <div class="node-dot"></div>
                <div class="card-wrapper" 
                     onmouseenter="playStack(this, ${count})" 
                     onmouseleave="stopStack(this)"
                     onclick="unfoldOrigami('${ev.images[0]}')">
                    
                    <div class="event-title">${ev.eventName}</div>
                    
                    <!-- The Stack Visual -->
                    <div class="photo-stack">
                        <div class="current-photo-box">
                            ${ev.images.map((src, i) => 
                                `<img src="${src}" class="${i===0?'active':''}" loading="lazy">`
                            ).join('')}
                            <div class="slide-progress"></div>
                        </div>
                    </div>

                    ${count > 1 ? `<div class="stack-badge">+${count} Images</div>` : ''}
                </div>
                <div style="width: 45%"></div>
            `;
            container.appendChild(card);
        });
    }

    /* --- 2. SLIDING STACK ANIMATION --- */
    let activeInterval;
    
    function playStack(wrapper, count) {
        if (count <= 1) return;
        const imgs = wrapper.querySelectorAll('img');
        const bar = wrapper.querySelector('.slide-progress');
        let idx = 0;
        
        // Reset
        imgs.forEach(img => img.classList.remove('active'));
        imgs[0].classList.add('active');

        activeInterval = setInterval(() => {
            imgs[idx].classList.remove('active');
            idx = (idx + 1) % count;
            imgs[idx].classList.add('active');
            
            // Progress Bar Animation
            let pct = ((idx + 1) / count) * 100;
            bar.style.width = pct + '%';
        }, 800);
    }

    function stopStack(wrapper) {
        clearInterval(activeInterval);
        wrapper.querySelector('.slide-progress').style.width = '0%';
    }

    /* --- 3. ADVANCED ORIGAMI UNFOLD --- */
    function unfoldOrigami(imgSrc) {
        const modal = document.getElementById('modal');
        const stage = document.getElementById('stage');
        const slices = document.querySelectorAll('.fold-slice');
        
        // 1. Set the image to all slices
        // Use high-res for modal (replace s800 with s0 or s2000)
        const highRes = imgSrc.replace('=s800', '=s2000');
        
        slices.forEach(slice => {
            slice.style.backgroundImage = `url(${highRes})`;
        });

        // 2. Show Modal
        modal.classList.add('open');

        // 3. Trigger Unfold Animation (Small delay to allow CSS display:flex to apply)
        setTimeout(() => {
            stage.classList.remove('folded');
            stage.classList.add('unfolded');
        }, 100);
    }

    function foldAndClose() {
        const stage = document.getElementById('stage');
        const modal = document.getElementById('modal');
        
        // 1. Fold back up
        stage.classList.remove('unfolded');
        stage.classList.add('folded');

        // 2. Hide modal after animation finishes
        setTimeout(() => {
            modal.classList.remove('open');
        }, 1200);
    }

    /* --- 4. FIRE BACKGROUND --- */
    const canvas = document.getElementById('bgCanvas');
    const ctx = canvas.getContext('2d');
    let p = [];
    const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    window.onresize = resize; resize();

    class Spark {
        constructor() { this.reset(); }
        reset() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height + 10;
            this.v = Math.random() * 2 + 1;
            this.s = Math.random() * 2;
            this.o = 1;
        }
        draw() {
            this.y -= this.v; this.o -= 0.01;
            if(this.o <= 0) this.reset();
            ctx.fillStyle = `rgba(255, 100, 0, ${this.o})`;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.s, 0, 7); ctx.fill();
        }
    }
    
    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(p.length < 60) p.push(new Spark());
        p.forEach(s => s.draw());
        requestAnimationFrame(loop);
    }
    loop();
    initGallery();
</script>

</body>
</html>
