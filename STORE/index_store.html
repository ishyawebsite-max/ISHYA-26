<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISHYA -26 STORE</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- QRCode Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- THEME: TACTICAL BIO-DIGITAL --- */
        :root {
            --bg-deep: #060606;
            --bg-panel: #181C10;
            --gold: #D6C26A;
            --olive: #3D4324;
            --green: #4D8F48;
            --text-main: #e0e5e0;
            --header-h: 80px;
            --font-head: 'Chakra Petch', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-head);
            overflow-x: hidden;
            padding-top: var(--header-h);
        }

        /* --- BACKGROUND FX --- */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background: radial-gradient(circle at center, #11150e 0%, #060606 100%);
        }
        .scanline {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9000;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }

        /* --- LOADER --- */
        #loader-wrapper {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 99999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-bar {
            width: 200px; height: 4px; background: var(--olive); margin-top: 15px; position: relative; overflow: hidden;
        }
        .loader-bar::after {
            content:''; position: absolute; top: 0; left: 0; width: 50%; height: 100%; background: var(--green);
            animation: loadAnim 1s infinite ease-in-out;
        }
        @keyframes loadAnim { 0% { left: -50%; } 100% { left: 100%; } }
        body.loaded #loader-wrapper { opacity: 0; visibility: hidden; }

        /* --- HEADER --- */
        header { 
            position: fixed; top: 0; width: 100%; height: var(--header-h); z-index: 100;
            background: rgba(6, 6, 6, 0.95); backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--olive);
            display: flex; align-items: center; justify-content: center; /* Center Title */
            padding: 0 20px;
        }
        
        .brand { 
            font-size: 1.8rem; font-weight: 700; color: var(--gold); 
            letter-spacing: 2px; text-transform: uppercase; text-align: center;
            line-height: 1;
        }
        .brand span { 
            color: var(--green); font-size: 0.8rem; display: block; 
            letter-spacing: 6px; margin-top: 2px;
        }
        
        .cart-btn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background: var(--bg-panel); color: var(--green); border: 1px solid var(--green);
            padding: 8px 16px; font-family: var(--font-mono); font-weight: bold; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.3s;
        }
        .cart-btn:hover { background: var(--green); color: #000; box-shadow: 0 0 15px var(--green); }

        /* --- GRID LAYOUT --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 25px; 
        }

        /* --- CARD DESIGN --- */
        .card {
            background: var(--bg-panel);
            border: 1px solid var(--olive);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            transition: 0.3s ease; position: relative; display: flex; flex-direction: column;
        }
        .card:hover { 
            border-color: var(--gold); transform: translateY(-3px); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .card-img-wrap { 
            width: 100%; height: 220px; background: #000; padding: 5px; position: relative; overflow: hidden;
        }
        .card-img { 
            width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.4s;
            filter: grayscale(40%);
        }
        .card:hover .card-img { opacity: 1; filter: grayscale(0%); transform: scale(1.05); }

        .card-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .cat-tag { font-family: var(--font-mono); font-size: 0.65rem; background: var(--gold); padding: 2px 6px; display: inline-block; margin-bottom: 5px; color: #000; font-weight: bold;}
        
        .card h3 { font-size: 1.1rem; margin-bottom: 5px; color: #fff; line-height: 1.2; }
        .card-price { color: var(--green); font-family: var(--font-mono); font-size: 1.1rem; margin-bottom: 10px; display: block; }

        .controls { display: flex; gap: 5px; margin-top: auto; }
        .controls select, .controls input {
            background: #000; border: 1px solid var(--olive); color: #fff;
            padding: 8px; font-family: var(--font-mono); font-size: 0.8rem; outline: none;
        }
        .controls input { width: 50px; text-align: center; }
        
        .add-btn {
            width: 100%; margin-top: 10px; padding: 10px;
            background: var(--green); color: #000; border: none;
            font-family: var(--font-head); font-weight: 700; cursor: pointer;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
            transition: 0.2s;
        }
        .add-btn:hover { background: var(--gold); }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--gold); color: #000; padding: 10px 25px;
            font-weight: bold; opacity: 0; transition: 0.4s; z-index: 10000;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* --- MODAL SYSTEM --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 10000; display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: var(--bg-panel); width: 95%; max-width: 500px;
            border: 1px solid var(--green); box-shadow: 0 0 30px rgba(77, 143, 72, 0.2);
            display: flex; flex-direction: column; max-height: 90vh;
        }
        
        .modal-header {
            padding: 15px 20px; background: rgba(77, 143, 72, 0.1); border-bottom: 1px solid var(--olive);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { color: var(--green); font-size: 1.2rem; text-transform: uppercase; }
        .close-icon { cursor: pointer; font-size: 1.5rem; color: var(--gold); }

        .modal-body { padding: 20px; overflow-y: auto; }
        
        /* Form Styling */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: var(--gold); font-size: 0.8rem; margin-bottom: 5px; font-family: var(--font-mono); }
        .input-box {
            width: 100%; padding: 12px; background: #0a0e0a; border: 1px solid var(--olive);
            color: #fff; font-family: var(--font-mono); outline: none; transition: 0.3s;
        }
        .input-box:focus { border-color: var(--green); }

        /* Cart List */
        .cart-item {
            display: flex; justify-content: space-between; padding: 10px;
            background: #000; border-left: 2px solid var(--olive); margin-bottom: 8px;
        }
        .cart-remove { color: #d64a4a; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* Summary */
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed var(--olive); font-family: var(--font-mono); font-size: 0.9rem; }
        .total-row { border-top: 2px solid var(--green); border-bottom: none; padding-top: 15px; font-size: 1.2rem; color: var(--gold); font-weight: bold; margin-top: 10px;}

        /* Buttons */
        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; font-weight: bold; cursor: pointer; font-family: var(--font-head); text-transform: uppercase; }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:hover { background: var(--gold); }
        .btn-sec { background: transparent; border: 1px solid var(--olive); color: #888; }
        .btn-sec:hover { color: #fff; border-color: #fff; }

        @media(max-width: 600px) {
            .grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .card-img-wrap { height: 160px; }
            .brand { font-size: 1.4rem; }
            .cart-btn { padding: 6px 12px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>

    <div class="scanline"></div>
    <canvas id="bg-canvas"></canvas>

    <div id="loader-wrapper">
        <h2 style="color:var(--gold); font-family:var(--font-mono)">OPENING SHOP</h2>
        <div class="loader-bar"></div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="brand">ISHYA -26 <span>STORE</span></div>
        <button class="cart-btn" onclick="openCart()">CART [<span id="cartCount">0</span>]</button>
    </header>

    <div class="container">
        <div class="grid" id="productGrid"></div>
    </div>

    <div id="toast" class="toast">ITEM ACQUIRED</div>

    <!-- MODAL WRAPPER -->
    <div class="modal-overlay" id="mainModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">CART</span>
                <span class="close-icon" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const API = "https://script.google.com/macros/s/AKfycbyld8a111hLb9SydZmH6K2dTAlAMG8a0HPdJ-oxoy8jjq01pkCLGwV5NInelko4QJpj5A/exec";
        
        // This will be populated from Google Sheet "Batch" tab
        let BATCH_UPI_MAP = {};

        // ================= STATE =================
        let products = [];
        let cart = [];
        let userDetails = {};
        
        // ================= INITIALIZATION =================
        window.onload = () => {
            initCanvas();
            fetchData();
        };

        async function fetchData() {
            try {
                const res = await fetch(API);
                const json = await res.json();
                
                // 1. Store Products
                if(json.products) {
                    products = json.products;
                    renderProducts();
                }

                // 2. Store Batches
                if(json.batches) {
                    BATCH_UPI_MAP = json.batches;
                }

                setTimeout(() => document.body.classList.add('loaded'), 800);
            } catch (e) { console.error("Data Fetch Error:", e); }
        }

        function renderProducts() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = products.map(p => `
                <div class="card">
                    <div class="card-img-wrap">
                        <img src="${p.images?.split(',')[0] || ''}" class="card-img" onerror="this.src='https://via.placeholder.com/300x300/181C10/4D8F48?text=NO+IMAGE'">
                    </div>
                    <div class="card-info">
                        <span class="cat-tag">${p.category}</span>
                        <h3>${p.name}</h3>
                        <span class="card-price">₹${p.price}</span>
                        <div class="controls">
                            <select id="size-${p.id}" style="flex:1">
                                ${(p.sizes || 'One Size').split(',').map(s=>`<option>${s.trim()}</option>`).join('')}
                            </select>
                            <input type="number" id="qty-${p.id}" value="1" min="1">
                        </div>
                        <button class="add-btn" onclick="addToCart('${p.id}')">ADD +</button>
                    </div>
                </div>
            `).join('');
        }

        // ================= CART LOGIC =================
        function addToCart(pid) {
            const p = products.find(x => String(x.id) === String(pid));
            const size = document.getElementById(`size-${pid}`).value;
            const qty = parseInt(document.getElementById(`qty-${pid}`).value);
            if(qty <= 0) return;
            
            const ex = cart.find(i => i.id === p.id && i.size === size);
            if(ex) ex.qty += qty; else cart.push({ ...p, size, qty });
            
            updateCartCount();
            showToast();
        }

        function updateCartCount() {
            const count = cart.reduce((a, b) => a + b.qty, 0);
            document.getElementById('cartCount').innerText = count;
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            updateCartCount();
            renderCartStep(); 
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        // ================= MODAL & STEPS =================
        const modal = document.getElementById('mainModal');
        const mTitle = document.getElementById('modalTitle');
        const mBody = document.getElementById('modalContent');

        function closeModal() { modal.style.display = 'none'; }
        function openCart() { modal.style.display = 'flex'; renderCartStep(); }

        // --- STEP 1: REVIEW CART ---
        function renderCartStep() {
            mTitle.innerText = "INVENTORY CHECK";
            if(cart.length === 0) {
                mBody.innerHTML = `<p style="text-align:center; color:#666; padding:20px;">Cart is empty.</p>
                <button class="btn btn-sec" onclick="closeModal()">RETURN TO STORE</button>`;
                return;
            }

            let total = 0;
            const html = cart.map((item, i) => {
                total += item.price * item.qty;
                return `
                <div class="cart-item">
                    <div>
                        <div style="color:#fff; font-weight:bold">${item.name}</div>
                        <div style="color:#888; font-size:0.8rem">${item.size} x ${item.qty}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color:var(--gold)">₹${item.price * item.qty}</div>
                        <span class="cart-remove" onclick="removeFromCart(${i})">REMOVE</span>
                    </div>
                </div>`;
            }).join('');

            mBody.innerHTML = `
                ${html}
                <div style="text-align:right; margin-top:15px; font-size:1.2rem; color:var(--green); font-weight:bold">TOTAL: ₹${total}</div>
                <div class="btn-row">
                    <button class="btn btn-sec" onclick="closeModal()">CLOSE</button>
                    <button class="btn btn-primary" onclick="renderDetailsStep()">CHECKOUT</button>
                </div>
            `;
        }

        // --- STEP 2: USER DETAILS ---
        function renderDetailsStep() {
            mTitle.innerText = "OPERATOR DETAILS";
            
            // Generate Batch Options Dynamically from Sheet Data
            let batchOptions = `<option value="">-- SELECT --</option>`;
            if (Object.keys(BATCH_UPI_MAP).length === 0) {
                batchOptions += `<option value="OTHERS">General Fund (Default)</option>`;
            } else {
                for (const key in BATCH_UPI_MAP) {
                    const isSelected = userDetails.batch === key ? 'selected' : '';
                    // key = BSMS21, BATCH_UPI_MAP[key].name = BSMS 21 Rep
                    batchOptions += `<option value="${key}" ${isSelected}>${key}</option>`;
                }
            }

            mBody.innerHTML = `
                <form id="detailsForm" onsubmit="saveDetailsAndProceed(event)">
                    <div class="form-group"><label>FULL NAME</label><input class="input-box" id="cName" required value="${userDetails.name||''}"></div>
                    <div class="form-group"><label>EMAIL</label><input class="input-box" type="email" id="cEmail" required value="${userDetails.email||''}"></div>
                    <div class="form-group"><label>PHONE</label><input class="input-box" type="tel" id="cPhone" required value="${userDetails.phone||''}"></div>
                    <div class="form-group"><label>ROLL NO (Optional)</label><input class="input-box" id="cRoll" value="${userDetails.roll||''}"></div>
                    <div class="form-group">
                        <label>BATCH (Crucial for Payment)</label>
                        <select class="input-box" id="cBatch" required>${batchOptions}</select>
                    </div>
                    <div class="form-group"><label>ADDRESS (Optional)</label><input class="input-box" id="cAddress" value="${userDetails.address||''}"></div>
                    
                    <div class="btn-row">
                        <button type="button" class="btn btn-sec" onclick="closeModal()">CLOSE</button>
                        <button type="button" class="btn btn-sec" onclick="renderCartStep()">BACK</button>
                        <button type="submit" class="btn btn-primary">REVIEW ORDER</button>
                    </div>
                </form>
            `;
        }

        function saveDetailsAndProceed(e) {
            e.preventDefault();
            userDetails = {
                name: document.getElementById('cName').value,
                email: document.getElementById('cEmail').value,
                phone: document.getElementById('cPhone').value,
                roll: document.getElementById('cRoll').value,
                batch: document.getElementById('cBatch').value,
                address: document.getElementById('cAddress').value
            };
            renderSummaryStep();
        }

        // --- STEP 3: ORDER SUMMARY ---
        function renderSummaryStep() {
            mTitle.innerText = "CONFIRM MANIFEST";
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            let cartSummary = cart.map(i => `
                <div class="summary-row"><span>${i.name} (${i.size}) x${i.qty}</span><span>₹${i.price*i.qty}</span></div>
            `).join('');

            mBody.innerHTML = `
                <div style="background:#000; padding:15px; border:1px solid var(--olive); margin-bottom:15px;">
                    <div class="summary-row"><span style="color:#888">NAME</span><span>${userDetails.name}</span></div>
                    <div class="summary-row"><span style="color:#888">BATCH</span><span style="color:var(--gold)">${userDetails.batch}</span></div>
                    <div class="summary-row"><span style="color:#888">CONTACT</span><span>${userDetails.phone}</span></div>
                    <hr style="border-color:var(--olive); margin:10px 0; border-style:dashed;">
                    ${cartSummary}
                    <div class="summary-row total-row"><span>PAYABLE TOTAL</span><span>₹${total}</span></div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-sec" onclick="renderDetailsStep()">EDIT DETAILS</button>
                    <button class="btn btn-primary" onclick="renderPaymentStep()">PROCEED TO PAY</button>
                </div>
            `;
        }

        // --- STEP 4: PAYMENT ---
        function renderPaymentStep() {
            mTitle.innerText = "PAYMENT UPLINK";
            
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            
            // Fetch correct UPI based on batch
            let batchInfo = BATCH_UPI_MAP[userDetails.batch];
            
            // Fallback if data is missing
            if (!batchInfo) {
                // Try finding an "OTHERS" key or just default
                if(BATCH_UPI_MAP["OTHERS"]) batchInfo = BATCH_UPI_MAP["OTHERS"];
                else batchInfo = { id: "", name: "Unknown Receiver" };
            }
            
            // Fallback UPI if ID is missing in sheet
            const payId = batchInfo.upi || "error@upi";
            const payName = batchInfo.name || userDetails.batch;
            
            const upiLink = `upi://pay?pa=${payId}&pn=${encodeURIComponent(payName)}&am=${total}&tn=MerchOrder`;

            mBody.innerHTML = `
                <div style="text-align:center">
                    <p style="color:#888; font-size:0.9rem">PAYING TO BATCH FUND:</p>
                    <h3 style="color:var(--green); margin-bottom:15px;">${payName}</h3>
                    <p style="font-size:0.7rem; color:#666;">ID: ${payId}</p>
                    
                    <div id="qr-container" style="background:#fff; padding:10px; display:inline-block; border:4px solid var(--gold);"></div>
                    
                    <div style="margin:20px 0;">
                        <a href="${upiLink}" class="btn btn-primary" style="display:block; text-decoration:none; padding:15px;">OPEN UPI APP</a>
                    </div>

                    <div class="form-group" style="text-align:left; margin-top:20px; border-top:1px solid var(--olive); padding-top:15px;">
                        <label>UPLOAD SCREENSHOT (REQUIRED)</label>
                        <input type="file" id="receiptFile" accept="image/*" class="input-box" style="padding:5px;">
                    </div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-sec" onclick="renderSummaryStep()">BACK</button>
                    <button class="btn btn-primary" onclick="submitFinalOrder()" id="btnSubmit">CONFIRM PAYMENT</button>
                </div>
            `;

            setTimeout(() => {
                new QRCode(document.getElementById("qr-container"), { text: upiLink, width: 150, height: 150 });
            }, 100);
        }

        // --- FINAL SUBMISSION ---
        async function submitFinalOrder() {
            const fileInput = document.getElementById('receiptFile');
            if(!fileInput.files[0]) { alert("Please upload the payment screenshot."); return; }

            const btn = document.getElementById('btnSubmit');
            btn.innerText = "TRANSMITTING..."; btn.disabled = true;

            const reader = new FileReader();
            reader.readAsDataURL(fileInput.files[0]);
            reader.onload = async () => {
                const base64 = reader.result;
                const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
                const orderId = "ORD-" + Math.floor(100000 + Math.random() * 900000);

                const payload = {
                    orderId: orderId,
                    customerName: userDetails.name,
                    customerEmail: userDetails.email,
                    customerPhone: userDetails.phone,
                    rollNumber: userDetails.roll || "N/A",
                    batch: userDetails.batch,
                    address: userDetails.address || "N/A",
                    totalPrice: total,
                    cart: cart,
                    receiptImage: base64
                };

                try {
                    const res = await fetch(API, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const result = await res.json();
                    if(result.status === 'success') {
                        mBody.innerHTML = `
                            <div style="text-align:center; padding:30px;">
                                <h2 style="color:var(--green)">ORDER SECURED</h2>
                                <p style="color:#fff; margin:10px 0;">ID: ${orderId}</p>
                                <p style="color:#888;">Confirmation sent to email.</p>
                                <button class="btn btn-primary" onclick="window.location.reload()" style="margin-top:20px;">DISMISS</button>
                            </div>
                        `;
                        cart = []; updateCartCount();
                    } else { throw new Error(result.message); }
                } catch (e) {
                    alert("Transmission Failed: " + e.message);
                    btn.innerText = "RETRY"; btn.disabled = false;
                }
            };
        }

        function initCanvas() {
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const particles = Array.from({length:50}, () => ({
                x: Math.random()*canvas.width, y: Math.random()*canvas.height,
                s: Math.random()*2, d: Math.random()*0.5 + 0.1
            }));
            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#4D8F48';
                particles.forEach(p => {
                    p.y -= p.d; if(p.y < 0) p.y = canvas.height;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
                });
                requestAnimationFrame(animate);
            }
            animate();
        }
    </script>
</body>
</html>
