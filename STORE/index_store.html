<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merch Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg: #121212;
            --paper-dark: #1e1e1e;
            --paper-light: #2c2c2c;
            --accent: #d4af37;
            --success: #4cc9f0;
            --text: #eeeeee;
            /* Space for the injected header */
            --header-h: 70px; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            padding-top: var(--header-h);
        }

        /* 1. LOADER */
        #origami-curtain {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: var(--bg); z-index: 99999;
            display: flex; justify-content: center; align-items: center;
            transition: visibility 0s linear 0.6s;
        }
        .star-wrapper { position: relative; }
        .shard {
            position: absolute; top: 0; left: 0; width: 0; height: 0;
            border-left: 50px solid transparent; border-right: 50px solid transparent;
            border-bottom: 200px solid var(--accent);
            transform-origin: 50% 100%; transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1);
        }
        .shard:nth-child(1) { transform: translate(-50%, -100%) rotate(0deg); }
        .shard:nth-child(2) { transform: translate(-50%, -100%) rotate(45deg); filter: brightness(0.8); }
        .shard:nth-child(3) { transform: translate(-50%, -100%) rotate(90deg); }
        .shard:nth-child(4) { transform: translate(-50%, -100%) rotate(135deg); filter: brightness(0.8); }
        .shard:nth-child(5) { transform: translate(-50%, -100%) rotate(180deg); }
        .shard:nth-child(6) { transform: translate(-50%, -100%) rotate(225deg); filter: brightness(0.8); }
        .shard:nth-child(7) { transform: translate(-50%, -100%) rotate(270deg); }
        .shard:nth-child(8) { transform: translate(-50%, -100%) rotate(315deg); filter: brightness(0.8); }

        body.loaded #origami-curtain { visibility: hidden; }
        body.loaded .shard { transform: translate(-50%, -100%) rotate(calc(var(--r)*45deg)) translateY(-150vh); }

        /* 2. CART FLOATER (Adjusted for mobile) */
        .cart-floater {
            position: fixed; 
            top: calc(var(--header-h) + 15px);
            right: 20px; 
            z-index: 9000;
            background: var(--accent); color: #000; padding: 12px 20px;
            font-weight: 900; font-size: 0.85rem; border: none;
            clip-path: polygon(15% 0, 100% 0, 100% 70%, 85% 100%, 0 100%, 0 30%);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
        }

        /* 3. SIDEBAR (CART) */
        .sidebar-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 10000; display: none; 
            backdrop-filter: blur(4px);
        }
        .sidebar {
            position: fixed; top: 0; right: -100%; width: 400px; height: 100%;
            background: var(--paper-dark); z-index: 10001; 
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }
        .sidebar.open { right: 0; }
        
        /* Fixed Sidebar Header */
        .sb-header { 
            padding: 20px; 
            background: #000; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 2px solid var(--accent);
            position: sticky; top: 0;
        }
        .sb-header h2 { font-size: 1.2rem; letter-spacing: 1px; }
        .close-sidebar {
            background: var(--accent); color: #000;
            width: 40px; height: 40px; border: none;
            font-size: 1.8rem; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
        }

        .sb-body { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .sb-footer { padding: 25px; background: #0a0a0a; border-top: 1px solid #333; }

        /* 4. PRODUCT GRID */
        header { text-align: center; padding: 40px 20px; }
        header h1 { font-size: 2.5rem; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        .card {
            background: var(--paper-dark);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            display: flex; flex-direction: column;
        }
        .card-img { width: 100%; height: 300px; object-fit: cover; background: #000; }
        .card-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        
        .add-btn {
            width: 100%; margin-top: 15px; padding: 15px; background: var(--text); color: #000; border: none;
            font-weight: 800; text-transform: uppercase; cursor: pointer;
            clip-path: polygon(0 0, 100% 0, 100% 80%, 92% 100%, 0 100%);
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 600px) {
            :root { --header-h: 60px; }
            .sidebar { width: 100%; }
            header h1 { font-size: 2rem; }
            
            /* Move cart button to bottom-right for thumb accessibility on mobile */
            .cart-floater {
                top: auto; bottom: 25px; right: 20px;
                padding: 16px 24px; font-size: 1rem;
            }
            /* Add extra bottom padding so grid items aren't hidden by the floating button */
            .container { padding-bottom: 100px; }
        }

        /* Modal fixes */
        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 20000; display: none; align-items: center; justify-content: center; }
        .modal { background: var(--paper-dark); width: 95%; max-width: 450px; padding: 25px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--accent); }
    </style>
</head>
<body>

    <!-- LOADER -->
    <div id="origami-curtain">
        <div class="star-wrapper">
            <div class="shard" style="--r:0"></div><div class="shard" style="--r:1"></div>
            <div class="shard" style="--r:2"></div><div class="shard" style="--r:3"></div>
            <div class="shard" style="--r:4"></div><div class="shard" style="--r:5"></div>
            <div class="shard" style="--r:6"></div><div class="shard" style="--r:7"></div>
        </div>
    </div>

    <!-- CART BUTTON -->
    <button class="cart-floater" onclick="toggleCart()">CART (<span id="cartCount">0</span>)</button>

    <header>
        <h1>Merchandise</h1>
        <p style="color:#666; font-size: 0.8rem; letter-spacing: 2px;">OFFICIAL COLLECTION</p>
    </header>

    <div class="container">
        <div class="grid" id="productGrid"></div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar-overlay" id="sbOverlay" onclick="toggleCart()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sb-header">
            <h2>INVENTORY</h2>
            <button class="close-sidebar" onclick="toggleCart()">&times;</button>
        </div>
        <div class="sb-body" id="cartItems">
            <p style="text-align:center; color:#555; margin-top:50px;">Your cart is empty.</p>
        </div>
        <div class="sb-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold;">
                <span>SUBTOTAL</span><span id="cartTotal" style="color:var(--accent);">₹0</span>
            </div>
            <button class="add-btn" onclick="openCheckout()">PROCEED TO CHECKOUT</button>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div class="modal-wrap" id="checkoutModal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:var(--accent)">CHECKOUT</h3>
                <span onclick="closeCheckout()" style="font-size:2rem; cursor:pointer;">&times;</span>
            </div>
            <div id="step1">
                <form onsubmit="goToPayment(event)">
                    <input type="text" id="cName" placeholder="Full Name" required style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #333; color:white;">
                    <input type="tel" id="cPhone" placeholder="Phone Number" required style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #333; color:white;">
                    <input type="email" id="cEmail" placeholder="Email Address" required style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #333; color:white;">
                    <textarea id="cAddress" placeholder="Delivery Address" required style="width:100%; padding:12px; margin-bottom:10px; background:#111; border:1px solid #333; color:white; height:80px;"></textarea>
                    <button type="submit" class="add-btn">NEXT</button>
                </form>
            </div>
            <div id="step2" style="display:none; text-align:center;">
                <p>Scan to pay: <strong id="payAmount"></strong></p>
                <div id="qrcode" style="background:white; padding:10px; display:inline-block; margin:15px 0;"></div>
                <input type="file" id="receiptFile" accept="image/*" required style="margin-bottom:15px; color:#888;">
                <button class="add-btn" onclick="submitOrder()" id="finalBtn">CONFIRM PAYMENT</button>
            </div>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxpERF04YBoeR9B-wet2Rl5XmFIDPSxr49VpqM2gjgvocngbPzIGSCZwczU2pvYxXVkmQ/exec";
        const UPI_ID = "8113099230@upi";
        
        let products = [];
        let cart = [];

        window.onload = () => { fetchProducts(); };

        async function fetchProducts() {
            try {
                const res = await fetch(API);
                const json = await res.json();
                products = json.data;
                renderProducts(products);
                document.body.classList.add('loaded');
            } catch (e) { alert("Error loading products"); }
        }

        function renderProducts(list) {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = list.map(p => `
                <div class="card">
                    <img src="${p.images?.split(',')[0] || ''}" class="card-img">
                    <div class="card-info">
                        <small style="color:var(--accent)">${p.category}</small>
                        <h3 style="margin:5px 0">${p.name}</h3>
                        <p style="color:#888">₹${p.price}</p>
                        <div style="margin-top:auto; display:flex; gap:5px; padding-top:10px;">
                            <select id="size-${p.id}" style="flex:1; background:#222; color:white; border:none; padding:5px;">
                                ${(p.sizes || 'Standard').split(',').map(s=>`<option>${s.trim()}</option>`).join('')}
                            </select>
                            <input type="number" id="qty-${p.id}" value="1" min="1" style="width:50px; background:#222; color:white; border:none; text-align:center;">
                        </div>
                        <button class="add-btn" onclick="addToCart('${p.id}')">ADD TO CART</button>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(pid) {
            const p = products.find(x => String(x.id) === String(pid));
            const size = document.getElementById(`size-${pid}`).value;
            const qty = parseInt(document.getElementById(`qty-${pid}`).value);
            
            const ex = cart.find(i => i.id === p.id && i.size === size);
            if(ex) ex.qty += qty; else cart.push({ ...p, size, qty });
            
            updateCart();
            // REMOVED openSidebar() from here per your request.
        }

        function updateCart() {
            const box = document.getElementById('cartItems');
            let total = 0, count = 0;
            if(cart.length === 0) {
                box.innerHTML = '<p style="text-align:center; color:#555; margin-top:50px;">Your cart is empty.</p>';
            } else {
                box.innerHTML = cart.map((item, i) => {
                    total += item.price * item.qty;
                    count += item.qty;
                    return `
                    <div style="background:var(--paper-light); padding:15px; margin-bottom:10px; display:flex; justify-content:space-between;">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.size} x ${item.qty}</small>
                        </div>
                        <div style="text-align:right">
                            <div>₹${item.price * item.qty}</div>
                            <small style="color:var(--accent); cursor:pointer" onclick="removeFromCart(${i})">REMOVE</small>
                        </div>
                    </div>`;
                }).join('');
            }
            document.getElementById('cartTotal').innerText = "₹" + total;
            document.getElementById('cartCount').innerText = count;
        }

        function removeFromCart(i) { cart.splice(i, 1); updateCart(); }
        
        function toggleCart() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sbOverlay');
            sb.classList.toggle('open');
            ov.style.display = sb.classList.contains('open') ? 'block' : 'none';
        }

        function openCheckout() {
            if(cart.length === 0) return;
            toggleCart();
            document.getElementById('checkoutModal').style.display = 'flex';
        }

        function closeCheckout() { document.getElementById('checkoutModal').style.display = 'none'; }

        function goToPayment(e) {
            e.preventDefault();
            const total = cart.reduce((a,b) => a + (b.price*b.qty), 0);
            document.getElementById('payAmount').innerText = "₹" + total;
            const upi = `upi://pay?pa=${UPI_ID}&pn=MerchStore&am=${total}&tn=Order`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: upi, width: 150, height: 150 });
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }

        async function submitOrder() {
            // Placeholder for your existing sheet submission logic
            alert("Order submitted successfully!");
            cart = []; updateCart(); closeCheckout();
        }

        // Header Injector
        fetch('/ISHYA-26/header.html')
            .then(res => res.text())
            .then(data => {
                const temp = document.createElement('div');
                temp.innerHTML = data;
                document.body.prepend(temp);
                const script = temp.querySelector('script');
                if (script) {
                    const newS = document.createElement('script');
                    newS.textContent = script.textContent;
                    document.body.appendChild(newS);
                }
            }).catch(e => console.log("No external header found."));
    </script>
</body>
</html>
